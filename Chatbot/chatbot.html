<!DOCTYPE html>
<html>
  <head>
    <title>Chatbot</title>
    <style>

      body{
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: rgb(54, 57, 63);
        color: #dcddde;
      }
      
      .send-button{
        background-color: rgb(88, 101, 242);
        color: white;
        padding: 12px 20px;
        margin-left: 10px;
        border: none;
        border-radius: 6px;
        font-size: 15px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      
      .send-button:hover {
        background-color: rgb(71, 82, 196);
      }
      
      .send-button:disabled {
        background-color: rgb(67, 70, 77);
        cursor: not-allowed;
      }
      
      .chat-input{
        background-color: rgb(64, 68, 75);
        border: none;
        border-radius: 8px;
        padding: 11px 16px;
        font-size: 14px;
        color: #dcddde;
        flex-grow: 1;
        font-family: inherit;
      }
      
      .chat-input::placeholder {
        color: rgb(114, 118, 125);
      }
      
      .chat-input:focus {
        outline: none;
        background-color: rgb(79, 84, 92);
      }

      .chat-input-container{
        display: flex;
        margin: 24px;
        margin-bottom: 30px;
      }

      .app-container{
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: rgb(54, 57, 63);
      }

      .chat-message-text{
        background-color: transparent;
        color: rgb(220, 221, 222);
        border-radius: 0;
        padding: 0;
        margin: 0;
        max-width: none;
        line-height: 1.375;
        font-size: 16px;
        word-wrap: break-word;
      }
      
      .chat-message-container {
        display: flex;
        padding: 8px 16px;
        margin: 0;
        position: relative;
        transition: background-color 0.1s;
      }
      
      .chat-message-container:hover {
        background-color: rgba(4, 4, 5, 0.07);
      }
      
      .chat-message-user .chat-message-container {
        flex-direction: row-reverse;
      }

      .chat-message-profile{
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 16px;
        flex-shrink: 0;
        cursor: pointer;
      }
      
      .chat-message-user .chat-message-profile {
        margin-right: 0;
        margin-left: 16px;
      }
      
      .chat-message-content {
        flex: 1;
        min-width: 0;
      }
      
      .chat-message-header {
        display: flex;
        align-items: baseline;
        margin-bottom: 2px;
      }
      
      .chat-message-username {
        font-weight: 500;
        font-size: 16px;
        color: rgb(255, 255, 255);
        margin-right: 8px;
        cursor: pointer;
      }
      
      .chat-message-username:hover {
        text-decoration: underline;
      }
      
      .chat-message-timestamp {
        font-size: 12px;
        color: rgb(163, 166, 170);
        font-weight: 400;
      }

      .chat-messages-container{
        flex-grow: 1;
        margin-top: 0;
        overflow-y: auto;
        padding: 8px 0;
      }
      
      .chat-messages-container::-webkit-scrollbar {
        width: 8px;
      }
      
      .chat-messages-container::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .chat-messages-container::-webkit-scrollbar-thumb {
        background-color: rgb(32, 34, 37);
        border-radius: 4px;
      }
      
      .status-indicator {
        text-align: center;
        margin: 16px;
        padding: 8px;
        background-color: rgba(88, 101, 242, 0.1);
        border: 1px solid rgba(88, 101, 242, 0.2);
        border-radius: 6px;
        font-size: 12px;
        color: rgb(88, 101, 242);
      }
      
      .status-connected {
        background-color: rgba(87, 242, 135, 0.1);
        border-color: rgba(87, 242, 135, 0.2);
        color: rgb(87, 242, 135);
      }
      
      .chat-header {
        background-color: rgb(47, 49, 54);
        padding: 12px 16px;
        border-bottom: 1px solid rgb(32, 34, 37);
        display: flex;
        align-items: center;
        box-shadow: 0 1px 0 rgba(4,4,5,0.2), 0 1.5px 0 rgba(6,6,7,0.05), 0 2px 0 rgba(4,4,5,0.05);
      }
      
      .chat-header-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 12px;
        flex-shrink: 0;
      }
      
      .chat-header-info {
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      
      .chat-header-username {
        font-size: 16px;
        font-weight: 600;
        color: white;
        margin: 0;
        line-height: 1.2;
      }
      
      .chat-header-status {
        font-size: 12px;
        color: rgb(163, 166, 170);
        margin: 0;
        line-height: 1.2;
        margin-top: 1px;
      }
      
      .chat-header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .header-icon {
        width: 24px;
        height: 24px;
        color: rgb(181, 186, 193);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.2s, background-color 0.2s;
      }
      
      .header-icon:hover {
        color: rgb(220, 221, 222);
        background-color: rgba(79, 84, 92, 0.16);
      }

    </style>
  </head>
  <body>

    <div class="js-container"></div>
    
    <script src="react-basics.js"></script>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">
      
      function ChatInput({chatMessages, setChatMessages}) {
        const [inputText, setInputText] = React.useState('');
        const [isLoading, setIsLoading] = React.useState(false);
        const [serverStatus, setServerStatus] = React.useState('Unknown');

        // Check server health on component mount
        React.useEffect(() => {
          checkServerHealth();
        }, []);

        async function checkServerHealth() {
          try {
            const response = await fetch('http://localhost:3001/api/health');
            const data = await response.json();
            setServerStatus(data.ollama);
          } catch (error) {
            setServerStatus('Server offline');
          }
        }

        function saveInputText(event) {
          setInputText(event.target.value);
        }
        
        function handleKeyPress(event) {
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        }
        
        async function sendMessage() {
          if (!inputText.trim() || isLoading) return;
          
          const userMessage = inputText.trim();
          const timestamp = new Date().toISOString();
          setInputText('');
          setIsLoading(true);
          
          const newChatMessages = [
            ...chatMessages,
            {
              message: userMessage,
              sender: 'user',
              id: crypto.randomUUID(),
              timestamp: timestamp,
              username: 'You'
            }
          ];
          setChatMessages(newChatMessages);

          try {
            const response = await fetch('http://localhost:3001/api/chat', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ 
                message: userMessage,
                userId: 'user123'
              })
            });

            const data = await response.json();
            
            if (data.success) {
              setChatMessages([
                ...newChatMessages,
                {
                  message: data.response,
                  sender: 'robot',
                  id: crypto.randomUUID(),
                  timestamp: new Date().toISOString(),
                  username: 'Asuna'
                }
              ]);
            } else {
              throw new Error(data.error || 'Failed to get response');
            }
            
          } catch (error) {
            console.error('Error:', error);
            setChatMessages([
              ...newChatMessages,
              {
                message: `Error: ${error.message || 'Please check if your backend server and Ollama are running.'}`,
                sender: 'robot',
                id: crypto.randomUUID(),
                timestamp: new Date().toISOString(),
                username: 'System'
              }
            ]);
          } finally {
            setIsLoading(false);
          }
        }

        return (
          <>
            {/* Status indicator */}
            <div className={`status-indicator ${serverStatus === 'Connected' ? 'status-connected' : ''}`}>
              Status: {serverStatus}
            </div>
            
            <div className="chat-input-container">
              <input 
                placeholder={isLoading ? "Asuna is typing..." : "Message @Asuna"} 
                onChange={saveInputText}
                onKeyPress={handleKeyPress}
                value={inputText}
                disabled={isLoading}
                className="chat-input"
              /> 
              <button 
                onClick={sendMessage}
                disabled={isLoading || !inputText.trim()}
                className="send-button"
              >
                {isLoading ? '‚è≥' : 'Send'}
              </button>
            </div>
          </>
        );
      }
      
      function ChatMessage(props) {
        const {message, sender, timestamp, username} = props;
        
        // Format timestamp
        const formatTime = (isoString) => {
          const date = new Date(isoString);
          const today = new Date();
          const isToday = date.toDateString() === today.toDateString();
          const isYesterday = date.toDateString() === new Date(today.getTime() - 24 * 60 * 60 * 1000).toDateString();
          
          const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          
          if (isToday) {
            return `Today at ${timeString}`;
          } else if (isYesterday) {
            return `Yesterday at ${timeString}`;
          } else {
            return `${date.toLocaleDateString()} ${timeString}`;
          }
        };

        return(
          <div className={`chat-message-${sender}`}>
            <div className="chat-message-container">
              <img 
                src={sender === 'robot' ? "Girl.jpeg" : "Boy.jpg"} 
                className="chat-message-profile"
                alt={`${username} avatar`}
              />
              <div className="chat-message-content">
                <div className="chat-message-header">
                  <span className="chat-message-username">{username}</span>
                  <span className="chat-message-timestamp">
                    {timestamp ? formatTime(timestamp) : 'Just now'}
                  </span>
                </div>
                <div className="chat-message-text">
                  {message}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function ChatMessages({ chatMessages }) { 
        const chatMessagesRef = React.useRef(null);

        React.useEffect(() => {
          const containerElem = chatMessagesRef.current
          if(containerElem){
            containerElem.scrollTop = containerElem.scrollHeight;
          }
        }, [chatMessages]);    
        
        return (
          <div className="chat-messages-container" ref={chatMessagesRef}>
            {chatMessages.map((chatMessage) => {
              return(
                <ChatMessage 
                  message={chatMessage.message}
                  sender={chatMessage.sender}
                  timestamp={chatMessage.timestamp}
                  username={chatMessage.username}
                  key={chatMessage.id}
                />
              );
            })}
          </div>
        );
      }

      function App(){ 
        const [chatMessages, setChatMessages] = React.useState([
          {
            message: 'Hello Asuna', 
            sender: 'user',
            id: 'id1',
            timestamp: new Date(Date.now() - 60000).toISOString(), 
            username: 'You'
          }, 
          {
            message: 'Hello! How can I help you today? üòä', 
            sender: 'robot',
            id: 'id2',
            timestamp: new Date(Date.now() - 30000).toISOString(), 
            username: 'Asuna'
          }
        ]);

        return (
          <div className="app-container">
            <div className="chat-header">
              <img 
                src="Girl.jpeg" 
                className="chat-header-avatar"
                alt="Asuna avatar"
              />
              <div className="chat-header-info">
                <h1 className="chat-header-username">Asuna</h1>
                <p className="chat-header-status">Online</p>
              </div>
              <div className="chat-header-actions">
                <div className="header-icon" title="Start Voice Call">üìû</div>
                <div className="header-icon" title="Start Video Call">üìπ</div>
                <div className="header-icon" title="Pinned Messages">üìå</div>
                <div className="header-icon" title="User Profile">üë§</div>
              </div>
            </div>
            <ChatMessages chatMessages={chatMessages} />
            <ChatInput
              chatMessages={chatMessages}
              setChatMessages={setChatMessages}
            />
          </div>
        );
      }

      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App/>);
    </script>
  </body>
</html>